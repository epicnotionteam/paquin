{%- comment -%}
  Product Grid Sidebar
  Supports:
  - Faceted filters (collection.filters) including metafield filters
  - Tag filters (collection.all_tags) for legacy mode

  Expected params from render:
  - context (collection)
  - filter_block
  - filter_type: 'faceted' or 'tag'
  - filter_style: 'groups' or 'tags'
  - filter_limit
  - show_filter_product_count
{%- endcomment -%}

{%- assign collection = context | default: collection -%}
{%- assign tag_limit = filter_limit | default: 999 | times: 1 -%}
{%- assign filter_type = filter_type | default: 'faceted' -%}
{%- assign filter_style = filter_style | default: 'tags' -%}
{%- assign show_filter_product_count = show_filter_product_count | default: true -%}

<div class="productgrid--sidebar-section" aria-label="Filters" data-productgrid-filters-content>
  <nav aria-label="Collection filters">

    {%- if filter_type == 'faceted' -%}
      {%- comment -%}
        FACETED FILTERS (Shopify Search & Discovery / collection.filters)
      {%- endcomment -%}

      <form id="CollectionFiltersForm" method="get" action="{{ collection.url }}">
        {%- comment -%} Preserve sort_by if present {%- endcomment -%}
        {%- if collection.sort_by != blank -%}
          <input type="hidden" name="sort_by" value="{{ collection.sort_by }}">
        {%- endif -%}

        {%- for filter in collection.filters -%}
          {%- if filter.type == 'price_range' -%}
            <details class="filter-group filter-group--price" {% if filter.min_value.value or filter.max_value.value %}open{% endif %}>
              <summary class="filter-group__title">{{ filter.label }}</summary>

              <div class="filter-group__content filter-group__content--price">
                <p style="background: yellow; color: black; padding: 4px;">FROM TEST</p>
                <div class="filter-price-field">
                  <label class="filter-price-field__title" for="FilterPriceFrom">From</label>
                  <input
                    class="filter-price-field__input"
                    id="FilterPriceFrom"
                    name="{{ filter.min_value.param_name }}"
                    type="number"
                    inputmode="numeric"
                    placeholder=""
                    value=""
                    autocomplete="off"
                  >
                </div>

                <span>To</span>
                <div class="filter-price-field">
                  <label class="filter-price-field__title" for="FilterPriceTo">To</label>
                  <input
                    class="filter-price-field__input"
                    id="FilterPriceTo"
                    name="{{ filter.max_value.param_name }}"
                    type="number"
                    inputmode="numeric"
                    placeholder=""
                    value=""
                    autocomplete="off"
                  >
                </div>
              </div>
            </details>

          {%- elsif filter.type == 'list' -%}
            {%- comment -%}
              This includes your metafield filter custom.primary_collection
              (and any other list-style filters)
            {%- endcomment -%}
            <details class="filter-group" {% if filter.active_values.size > 0 %}open{% endif %}>
              <summary class="filter-group__title">{{ filter.label }}</summary>

              <div class="filter-group__content">
                {%- for v in filter.values -%}
                  <label class="filter-item">
                    <input
                      type="checkbox"
                      name="{{ v.param_name }}"
                      value="{{ v.value }}"
                      {% if v.active %}checked{% endif %}
                      {% if v.count == 0 and v.active == false %}disabled{% endif %}
                    >
                    <span class="filter-item__label">{{ v.label }}</span>
                    {%- if show_filter_product_count -%}
                      <span class="filter-item__count">({{ v.count }})</span>
                    {%- endif -%}
                  </label>
                {%- endfor -%}
              </div>
            </details>
          {%- endif -%}
        {%- endfor -%}

        <noscript>
          <button type="submit" class="button--base">Apply filters</button>
        </noscript>
      </form>

      <script>
        (function () {
          var form = document.getElementById('CollectionFiltersForm');
          if (!form) return;

          form.addEventListener('change', function (e) {
            var t = e.target;
            if (!t) return;
            if (t.type === 'checkbox' || t.type === 'number' || t.tagName === 'SELECT') {
              form.submit();
            }
          });
        })();
      </script>

    {%- else -%}
      {%- comment -%}
        TAG FILTERS (legacy)
      {%- endcomment -%}

      {%- if collection.all_tags.size > 0 and filter_style != 'none' -%}
        {% capture cat_array %}{%- render 'advanced-tag-loop', block: filter_block -%}{% endcapture %}
        {% assign cat_array = cat_array | split: '|' %}

        {% if filter_style == 'groups' %}
          {%
            render 'product-grid-tag-groups',
            block: filter_block,
            tag_limit: tag_limit,
            cat_array: cat_array
          %}
        {% endif %}

        {% if filter_style == 'tags' %}
          {%
            render 'product-grid-tags',
            block: filter_block,
            tag_limit: tag_limit,
            cat_array: cat_array
          %}
        {% endif %}
      {%- endif -%}

    {%- endif -%}

  </nav>
</div>
